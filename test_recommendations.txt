ELLE2 TEST COVERAGE - DETAILED RECOMMENDATIONS
==============================================

TEST ORGANIZATION STRATEGY
==========================

UNIT TESTS (in-module tests):
- For modules with isolated logic (parsing, conversion, analysis)
- Place #[cfg(test)] mod tests blocks at end of files
- Test individual functions with specific inputs
- Location: Each .rs file has its own test module

INTEGRATION TESTS (tests/ directory):
- For multi-module workflows (compiler pipeline, VM execution)
- Test end-to-end scenarios
- Test error handling and edge cases
- Location: /tests/integration/

RECOMMENDED TEST FILE ORGANIZATION:
tests/integration/
├── compiler/
│   ├── conversion_tests.rs     (value_to_expr, patterns)
│   ├── analysis_tests.rs       (capture analysis, variable tracking)
│   ├── compilation_tests.rs    (full compile pipeline)
│   └── closure_tests.rs        (capture resolution)
├── vm/
│   ├── closure_execution_tests.rs
│   ├── scope_tests.rs
│   └── instruction_tests.rs
├── ffi/
│   ├── primitives_tests.rs
│   ├── calling_tests.rs
│   └── memory_tests.rs
└── primitives/
    ├── arithmetic_tests.rs
    ├── string_tests.rs
    ├── file_io_tests.rs
    └── registration_tests.rs

=== PRIORITY 1: CRITICAL PATH MODULES ===
(These block other functionality - test first)

1. src/compiler/capture_resolution.rs
   ├─ Module: Fixes capture indices in nested lambdas
   ├─ Complexity: HIGH - 3-phase environment layout algorithm
   ├─ Impact: Broken → closures segfault or wrong captures
   ├─ Public Function: resolve_captures(&mut Expr)
   ├─ Tests Needed:
   │  ├─ test_single_lambda_no_captures
   │  ├─ test_lambda_with_local_captures
   │  ├─ test_nested_lambda_capture_resolution
   │  ├─ test_deeply_nested_lambda_captures (3+ levels)
   │  ├─ test_capture_with_local_shadowing
   │  └─ test_mixed_params_and_captures
   ├─ Test Location: Unit tests in module + integration tests/integration/compiler/closure_tests.rs
   └─ Est. Time: 4-6 hours

2. src/compiler/converters.rs
   ├─ Module: value_to_expr() converts Value AST to Expr AST
   ├─ Complexity: HIGH - handles patterns, let bindings, destructuring
   ├─ Impact: Broken → all compilation fails
   ├─ Public Function: value_to_expr(&Value, &mut SymbolTable) -> Result<Expr>
   ├─ Tests Needed:
   │  ├─ test_literal_conversion
   │  ├─ test_symbol_conversion
   │  ├─ test_list_function_call_conversion
   │  ├─ test_lambda_conversion
   │  ├─ test_let_binding_conversion
   │  ├─ test_pattern_extraction
   │  ├─ test_nested_expressions
   │  ├─ test_error_on_invalid_syntax
   │  └─ test_environment_tracking
   ├─ Test Location: Unit tests + tests/integration/compiler/conversion_tests.rs
   └─ Est. Time: 5-7 hours

3. src/compiler/analysis.rs
   ├─ Module: Analyzes variable usage in expressions
   ├─ Complexity: MEDIUM - recursive AST traversal
   ├─ Impact: Dead code not eliminated (performance)
   ├─ Public Functions:
   │  ├─ analyze_capture_usage(&Expr, &HashSet<SymbolId>, &HashSet<SymbolId>) -> HashSet<SymbolId>
   │  └─ analyze_free_vars(&Expr, &HashSet<SymbolId>) -> HashSet<SymbolId>
   ├─ Tests Needed:
   │  ├─ test_capture_usage_with_no_vars
   │  ├─ test_capture_usage_with_local_bindings
   │  ├─ test_free_vars_in_lambda
   │  ├─ test_nested_scope_analysis
   │  └─ test_shadowed_variables
   ├─ Test Location: tests/integration/compiler/analysis_tests.rs
   └─ Est. Time: 3-4 hours

=== PRIORITY 2: LARGE & COMPLEX MODULES ===
(High functionality, high surface area)

4. src/primitives/file_io.rs (405 lines, 20 functions)
   ├─ Module: File I/O primitives
   ├─ Impact: File operations broken
   ├─ Functions to test:
   │  ├─ prim_open_file, prim_close_file
   │  ├─ prim_read_line, prim_read_string
   │  ├─ prim_write_string, prim_write_line
   │  ├─ prim_file_exists, prim_delete_file
   │  └─ Error handling for all
   ├─ Tests Needed:
   │  ├─ test_file_operations_basic
   │  ├─ test_file_read_write_round_trip
   │  ├─ test_file_not_found_error
   │  ├─ test_permission_errors
   │  ├─ test_file_handle_management
   │  └─ test_concurrent_file_access
   ├─ Test Location: tests/integration/primitives/file_io_tests.rs
   └─ Est. Time: 5-7 hours

5. src/primitives/string.rs (346 lines, 26 functions)
   ├─ Module: String manipulation primitives
   ├─ Impact: String operations broken
   ├─ Function Categories:
   │  ├─ String construction: string-append, string-repeat
   │  ├─ String queries: string-length, string-ref
   │  ├─ String modification: string-upcase, string-downcase
   │  ├─ String analysis: string-contains, string-starts-with
   │  └─ String conversion: string->symbol, symbol->string
   ├─ Tests Needed:
   │  ├─ test_string_append_empty_and_non_empty
   │  ├─ test_string_repeat_edge_cases
   │  ├─ test_string_substring_operations
   │  ├─ test_string_case_conversion
   │  ├─ test_string_searching
   │  ├─ test_string_split_join
   │  └─ test_unicode_handling
   ├─ Test Location: tests/integration/primitives/string_tests.rs
   └─ Est. Time: 6-8 hours

6. src/ffi/primitives/handlers.rs (253 lines, 10 functions)
   ├─ Module: Custom type handler registration
   ├─ Complexity: MEDIUM - handler registry management
   ├─ Impact: Custom FFI types break
   ├─ Functions to test:
   │  ├─ prim_define_custom_handler
   │  ├─ prim_unregister_custom_handler
   │  ├─ Handler lookup and invocation
   │  └─ Priority-based handler selection
   ├─ Tests Needed:
   │  ├─ test_handler_registration
   │  ├─ test_handler_lookup
   │  ├─ test_handler_priority
   │  ├─ test_handler_unregistration
   │  ├─ test_duplicate_handler_names
   │  └─ test_handler_invocation
   ├─ Test Location: tests/integration/ffi/primitives_tests.rs
   └─ Est. Time: 4-6 hours

7. src/primitives/registration.rs (356 lines, 9 functions)
   ├─ Module: Primitive function registration system
   ├─ Impact: Primitives unavailable → all code breaks
   ├─ Key Functions: register_all_primitives, register_*_primitives
   ├─ Tests Needed:
   │  ├─ test_primitive_registration_counts
   │  ├─ test_primitive_lookup
   │  ├─ test_duplicate_registration
   │  ├─ test_primitive_arity_checking
   │  └─ test_namespace_isolation
   ├─ Test Location: tests/integration/primitives/registration_tests.rs
   └─ Est. Time: 3-4 hours

8. src/vm/mod.rs (433 lines, main VM loop)
   ├─ Module: Virtual machine execution loop
   ├─ Complexity: HIGH - instruction dispatch, stack management
   ├─ Impact: VM crashes or hangs
   ├─ Critical Functions:
   │  ├─ VM::execute(&Bytecode)
   │  ├─ Instruction dispatch loop
   │  └─ Error propagation
   ├─ Tests Needed:
   │  ├─ test_simple_literal_execution
   │  ├─ test_arithmetic_instruction_sequence
   │  ├─ test_function_call_dispatch
   │  ├─ test_stack_underflow_detection
   │  ├─ test_instruction_error_recovery
   │  └─ test_large_execution_sequences
   ├─ Test Location: tests/integration/vm/instruction_tests.rs
   └─ Est. Time: 6-8 hours

=== PRIORITY 3: FFI MODULES ===
(High complexity, isolated)

9. src/ffi/primitives/calling.rs (150 lines, 2 functions)
   ├─ Module: C function calling interface
   ├─ Complexity: HIGH - libffi integration
   ├─ Impact: FFI calls fail completely
   ├─ Functions: prim_call_c_function, prim_call_c_function_wrapper
   ├─ Tests Needed:
   │  ├─ test_simple_c_function_call
   │  ├─ test_argument_marshaling
   │  ├─ test_return_value_unmarshaling
   │  ├─ test_type_mismatch_errors
   │  └─ test_library_symbol_resolution
   ├─ Test Location: tests/integration/ffi/calling_tests.rs
   ├─ Note: May need test C library (see tests/fixtures/)
   └─ Est. Time: 5-7 hours

10. src/ffi/primitives/memory.rs (171 lines, 12 functions)
    ├─ Module: Memory management for FFI
    ├─ Impact: Memory leaks or dangling pointers
    ├─ Functions to test:
    │  ├─ prim_malloc, prim_free
    │  ├─ prim_write_*, prim_read_*
    │  ├─ prim_memcpy, prim_memset
    │  └─ Error handling
    ├─ Tests Needed:
    │  ├─ test_allocate_and_free
    │  ├─ test_write_read_memory_round_trip
    │  ├─ test_double_free_detection
    │  ├─ test_use_after_free_detection
    │  ├─ test_memory_bounds_checking
    │  └─ test_alignment_handling
    ├─ Test Location: tests/integration/ffi/memory_tests.rs
    └─ Est. Time: 4-6 hours

11. src/ffi/marshal/union_marshal.rs (85 lines, 2 functions)
    ├─ Module: C union marshaling
    ├─ Impact: Union values marshaled incorrectly
    ├─ Functions: marshal_union_with_layout, unmarshal_union_with_layout
    ├─ Tests Needed:
    │  ├─ test_union_marshal_single_field
    │  ├─ test_union_marshal_field_overlap
    │  ├─ test_union_unmarshal_all_fields
    │  ├─ test_union_size_mismatch_error
    │  └─ test_union_with_complex_types
    ├─ Test Location: tests/integration/ffi/union_marshal_tests.rs (extend existing)
    └─ Est. Time: 2-3 hours

12. src/ffi/marshal/cvalue.rs (46 lines, CValue enum)
    ├─ Module: C value representation
    ├─ Impact: Low (mostly data)
    ├─ Functions: as_raw() - converts Value to raw bytes
    ├─ Tests Needed:
    │  ├─ test_int_to_raw_bytes
    │  ├─ test_float_to_raw_bytes
    │  ├─ test_pointer_to_raw_bytes
    │  ├─ test_string_pointer_marshaling
    │  └─ test_array_handling
    ├─ Test Location: Unit tests in module
    └─ Est. Time: 1-2 hours

=== PRIORITY 4: VM & RUNTIME MODULES ===
(Execution-critical but better isolated)

13. src/vm/closure.rs (39 lines, 1 function)
    ├─ Module: Closure creation at runtime
    ├─ Function: handle_make_closure
    ├─ Tests Needed:
    │  ├─ test_closure_creation_basic
    │  ├─ test_closure_capture_values
    │  ├─ test_closure_arity_preservation
    │  └─ test_closure_stack_underflow
    ├─ Test Location: tests/integration/vm/closure_execution_tests.rs
    └─ Est. Time: 2-3 hours

14. src/vm/scope/handlers.rs (63 lines, 4 functions)
    ├─ Module: Scope push/pop at runtime
    ├─ Functions: handle_push_scope, handle_pop_scope, handle_load_scoped, handle_store_scoped
    ├─ Tests Needed:
    │  ├─ test_push_pop_scope_basic
    │  ├─ test_global_scope_cannot_pop
    │  ├─ test_multiple_scope_levels
    │  └─ test_scope_type_conversion
    ├─ Test Location: tests/integration/vm/scope_tests.rs
    └─ Est. Time: 2-3 hours

=== PRIORITY 5: PRIMITIVES MODULES ===
(Many small modules, test together)

15. src/primitives/{arithmetic,comparison,math,logic}.rs
    ├─ Modules: Basic operations (arithmetic, comparison, logical)
    ├─ Combined: 360 lines, 26 functions
    ├─ Tests Needed:
    │  ├─ test_arithmetic_add_sub_mul_div
    │  ├─ test_numeric_comparisons
    │  ├─ test_logical_operations
    │  ├─ test_type_checking_in_operations
    │  ├─ test_edge_cases_zero_negative
    │  ├─ test_division_by_zero
    │  └─ test_float_precision
    ├─ Test Location: tests/integration/primitives/arithmetic_tests.rs
    └─ Est. Time: 4-5 hours

16. src/primitives/{list,vector,table}.rs
    ├─ Modules: Data structure operations
    ├─ Combined: 328 lines, 20 functions
    ├─ Tests Needed:
    │  ├─ test_list_construction_and_access
    │  ├─ test_vector_operations
    │  ├─ test_table_operations
    │  ├─ test_immutability_semantics
    │  └─ test_nested_structures
    ├─ Test Location: tests/integration/primitives/data_structure_tests.rs
    └─ Est. Time: 4-6 hours

17. src/primitives/{higher_order,higher_order_def}.rs (148 lines)
    ├─ Modules: map, filter, fold, reduce
    ├─ Tests Needed:
    │  ├─ test_map_with_closure
    │  ├─ test_filter_with_predicate
    │  ├─ test_fold_accumulation
    │  ├─ test_compose_functions
    │  └─ test_higher_order_with_edge_cases
    ├─ Test Location: tests/integration/primitives/higher_order_tests.rs
    └─ Est. Time: 3-4 hours

18. src/primitives/{exception,signaling,display,debug}.rs (396 lines)
    ├─ Note: signaling.rs HAS tests
    ├─ Tests Needed (others):
    │  ├─ test_exception_creation
    │  ├─ test_display_formatting
    │  ├─ test_debug_output
    │  └─ test_exception_properties
    ├─ Test Location: tests/integration/primitives/exception_tests.rs
    └─ Est. Time: 3-4 hours

19. src/primitives/{module_init,module_loading,package}.rs (284 lines)
    ├─ Modules: Module system
    ├─ Complexity: MEDIUM - module loading/caching
    ├─ Tests Needed:
    │  ├─ test_module_loading
    │  ├─ test_module_caching
    │  ├─ test_missing_module_error
    │  ├─ test_circular_dependency_handling
    │  └─ test_package_initialization
    ├─ Test Location: tests/integration/primitives/module_tests.rs
    └─ Est. Time: 4-5 hours

20. src/ffi/primitives/{callbacks,context,enums,library,types,wrappers}.rs (602 lines)
    ├─ Combined: 602 lines, 28+ functions
    ├─ Modules: Various FFI support
    ├─ Tests Needed:
    │  ├─ test_library_loading
    │  ├─ test_symbol_resolution
    │  ├─ test_type_parsing
    │  ├─ test_callback_registration
    │  ├─ test_enum_marshaling
    │  └─ test_context_management
    ├─ Test Location: tests/integration/ffi/ffi_support_tests.rs
    └─ Est. Time: 6-8 hours

=== PRIORITY 6: MINOR MODULES ===
(Low complexity, can be batched)

- src/compiler/patterns.rs (44 lines)
- src/primitives/{meta,type_check,utility,concurrency,display}.rs (417 lines)
- src/primitives/macros.rs (61 lines)
- src/vm/{arithmetic,comparison,control,data,literals,stack,types,variables}.rs (408 lines)

Combined: ~930 lines, 50+ functions
Tests Needed: Basic unit tests for each function
Test Location: Inline unit tests + tests/integration/misc_tests.rs
Est. Time: 6-8 hours

=== SUMMARY OF EFFORT ===

Priority | Modules        | Est. Hours | Critical?
---------|----------------|------------|----------
1        | 3 modules      | 12-17      | YES ✓
2        | 5 modules      | 24-33      | YES ✓
3        | 3 modules      | 11-16      | YES ✓
4        | 2 modules      | 4-6        | MEDIUM
5        | 6 modules      | 24-32      | MEDIUM
6        | ~7 modules     | 6-8        | LOW

TOTAL ESTIMATED EFFORT: 81-112 hours (2-3 weeks for one developer)

RECOMMENDED APPROACH:
1. Start with Priority 1 (capture_resolution, converters) - these block everything
2. Move to Priority 2 (large/complex modules)
3. Tackle Priority 3 (FFI) in parallel if FFI specialist available
4. Use auto-generation tools for Priority 6 (boilerplate tests)

TESTING BEST PRACTICES:
- Use property-based testing (proptest) for algorithms
- Use mocking/fixtures for FFI testing
- Create helper functions for VM test setup
- Document test assumptions in comments
- Aim for 80%+ code coverage in critical modules

