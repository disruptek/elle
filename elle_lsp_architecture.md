# Elle-LSP Architecture Diagram & Data Flow

## System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        IDE/Editor (VS Code, Emacs, etc)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  Open File / Edit / Hover / Ctrl+Click / Ctrl+Space                    â”‚
â”‚      â†“                  â†“      â†“       â†“              â†“                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚       LSP Client (Built into editor)                     â”‚            â”‚
â”‚  â”‚  - textDocument/didOpen                                  â”‚            â”‚
â”‚  â”‚  - textDocument/didChange                                â”‚            â”‚
â”‚  â”‚  - textDocument/hover                                    â”‚            â”‚
â”‚  â”‚  - textDocument/definition                               â”‚            â”‚
â”‚  â”‚  - textDocument/references                               â”‚            â”‚
â”‚  â”‚  - textDocument/completion                               â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                             â†“                                             â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚              â”‚  JSON-RPC over stdio         â”‚                             â”‚
â”‚              â”‚  Content-Length: N\r\n      â”‚                             â”‚
â”‚              â”‚  {JSON-RPC-message}         â”‚                             â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘                                                â†“
         â”‚                                                â”‚
    stdin/stdout pipes                                    â”‚
         â”‚                                                â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               LSP Server (elle-lsp binary)                               â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  main.rs:20-60 - Message Loop                                  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚    â”‚
â”‚  â”‚  â”‚ loop {                                             â”‚          â”‚    â”‚
â”‚  â”‚  â”‚   1. Read headers until Content-Length            â”‚          â”‚    â”‚
â”‚  â”‚  â”‚   2. Read message body (N bytes)                  â”‚          â”‚    â”‚
â”‚  â”‚  â”‚   3. Parse as JSON-RPC                            â”‚          â”‚    â”‚
â”‚  â”‚  â”‚   4. Dispatch to handle_request()                 â”‚          â”‚    â”‚
â”‚  â”‚  â”‚   5. Send response with Content-Length            â”‚          â”‚    â”‚
â”‚  â”‚  â”‚ }                                                  â”‚          â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  main.rs:63-165 - Request Handler                              â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚  match method {                                                â”‚    â”‚
â”‚  â”‚     "initialize" â”€â”€â”€â”€â”€â”€â”€â†’ âœ… Initialize handler                â”‚    â”‚
â”‚  â”‚     "shutdown" â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ âœ… Shutdown handler                  â”‚    â”‚
â”‚  â”‚     "didOpen" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ âœ… Document tracking                 â”‚    â”‚
â”‚  â”‚     "didChange" â”€â”€â”€â”€â”€â”€â”€â”€â†’ âœ… Document update                   â”‚    â”‚
â”‚  â”‚     "didClose" â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ âœ… Document removal                  â”‚    â”‚
â”‚  â”‚     "hover" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ âš ï¸  Stub (returns generic text)      â”‚    â”‚
â”‚  â”‚     "definition" â”€â”€â”€â”€â”€â”€â”€â†’ âŒ Not implemented                    â”‚    â”‚
â”‚  â”‚     "references" â”€â”€â”€â”€â”€â”€â”€â†’ âŒ Not implemented                    â”‚    â”‚
â”‚  â”‚     "completion" â”€â”€â”€â”€â”€â”€â”€â†’ âŒ Not implemented                    â”‚    â”‚
â”‚  â”‚     _ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ âŒ Return null                        â”‚    â”‚
â”‚  â”‚  }                                                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ documents: HashMap             â”‚ â”‚ Other State (TODO):          â”‚    â”‚
â”‚  â”‚ uri â†’ source_code_text         â”‚ â”‚ - Symbol index               â”‚    â”‚
â”‚  â”‚                                â”‚ â”‚ - AST cache                  â”‚    â”‚
â”‚  â”‚ Usage:                         â”‚ â”‚ - Scope information          â”‚    â”‚
â”‚  â”‚ - didOpen: insert              â”‚ â”‚ - Diagnostic cache           â”‚    â”‚
â”‚  â”‚ - didChange: update            â”‚ â”‚                              â”‚    â”‚
â”‚  â”‚ - didClose: remove             â”‚ â”‚ Current: NOT IMPLEMENTED     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Integration with elle-lint (MISSING)                           â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚  TODO: In didChange handler:                                   â”‚    â”‚
â”‚  â”‚    let mut linter = Linter::new(...);                          â”‚    â”‚
â”‚  â”‚    linter.lint_str(&text, uri)?;                               â”‚    â”‚
â”‚  â”‚    for diag in linter.diagnostics() {                          â”‚    â”‚
â”‚  â”‚        send_diagnostic_notification(uri, diag);                â”‚    â”‚
â”‚  â”‚    }                                                            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                      â†“                      â†“
         â”‚                      â”‚                      â”‚
         â†“                      â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   elle Crate     â”‚  â”‚  elle-lint Crate â”‚  â”‚  lsp-types Crate â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚ âœ… SymbolTable   â”‚  â”‚ âœ… Linter        â”‚  â”‚ âœ… Diagnostics   â”‚
â”‚ âœ… Lexer/Reader  â”‚  â”‚ âœ… Diagnostic    â”‚  â”‚ âœ… Position      â”‚
â”‚ âœ… Compiler      â”‚  â”‚ âœ… Severity      â”‚  â”‚ âœ… Range         â”‚
â”‚ âœ… AST (Expr)    â”‚  â”‚ âœ… Rules         â”‚  â”‚ âœ… Location      â”‚
â”‚ âœ… SourceLoc     â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚                  â”‚  â”‚ Rules:           â”‚  â”‚                  â”‚
â”‚ Used for:        â”‚  â”‚ âœ… naming        â”‚  â”‚                  â”‚
â”‚ - Parsing        â”‚  â”‚ âŒ arity (stub)  â”‚  â”‚                  â”‚
â”‚ - Symbol lookup  â”‚  â”‚ ğŸ”´ others        â”‚  â”‚                  â”‚
â”‚ - Type checking  â”‚  â”‚                  â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: How a Hover Request Works

```
IDE User
   â†“ Hovers over symbol "my-func"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Client sends:                     â”‚
â”‚ {                                     â”‚
â”‚   "jsonrpc": "2.0",                  â”‚
â”‚   "id": 5,                           â”‚
â”‚   "method": "textDocument/hover",    â”‚
â”‚   "params": {                        â”‚
â”‚     "textDocument": {"uri": "..."},  â”‚
â”‚     "position": {"line": 10, "ch": 15}â”‚
â”‚   }                                  â”‚
â”‚ }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ (via stdin)
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Server (main.rs:148)                                     â”‚
â”‚                                                              â”‚
â”‚ Current behavior (STUB):                                     â”‚
â”‚ return {                                                     â”‚
â”‚   "result": {                                                â”‚
â”‚     "contents": "Elle Lisp symbol information"              â”‚
â”‚   }                                                          â”‚
â”‚ }                                                            â”‚
â”‚                                                              â”‚
â”‚ âŒ PROBLEM: Doesn't actually look up symbol!               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚ (via stdout)
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IDE shows generic hover text         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


WHAT IT SHOULD DO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IDE User
   â†“ Hovers over symbol "my-func"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Client sends hover request       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Server - Improved Handler                                â”‚
â”‚                                                              â”‚
â”‚ 1. Get document: doc = documents.get(uri)                   â”‚
â”‚                                                              â”‚
â”‚ 2. Parse: create Lexer, tokenize document                   â”‚
â”‚    tokens = lex(doc)                                        â”‚
â”‚                                                              â”‚
â”‚ 3. Find token at position (line 10, char 15)               â”‚
â”‚    if token.loc matches position:                           â”‚
â”‚        symbol_id = extract_symbol_id(token)                â”‚
â”‚        symbol_name = symbols.name(symbol_id)               â”‚
â”‚                                                              â”‚
â”‚ 4. Look up information:                                     â”‚
â”‚    - Is it a builtin? builtin_arity(name)                 â”‚
â”‚    - Is it user-defined? symbol_definitions.get(id)       â”‚
â”‚    - What's its type? extract from AST                     â”‚
â”‚                                                              â”‚
â”‚ 5. Format response:                                         â”‚
â”‚    return {                                                 â”‚
â”‚      "result": {                                            â”‚
â”‚        "contents": "(fn [x] ...) - Returns x + 1"          â”‚
â”‚      }                                                      â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IDE shows actual hover information   â”‚
â”‚ "(fn [x] ...) - Returns x + 1"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow: Diagnostics (Currently Missing)

```
IDE User edits file
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Client sends didChange           â”‚
â”‚ (textDocument/didChange)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Server - main.rs:116 (didChange handler)               â”‚
â”‚                                                              â”‚
â”‚ Current: Just updates documents HashMap                      â”‚
â”‚ âœ… documents.insert(uri, new_text);                        â”‚
â”‚                                                              â”‚
â”‚ Missing: Should call linter                                 â”‚
â”‚ âŒ linter.lint_str(&text, uri);                            â”‚
â”‚ âŒ Publish diagnostics back to client                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IDE shows NO diagnostics            â”‚ â† PROBLEM!
â”‚ (even though there are lint errors)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


WHAT IT SHOULD DO:
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

IDE User edits file:
   â†“ Introduces naming error:
   â”‚ (define myVariable 10)  â† camelCase!
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Client sends didChange           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Server - Improved didChange Handler                      â”‚
â”‚                                                              â”‚
â”‚ 1. Update document                                          â”‚
â”‚    documents.insert(uri, new_text);                         â”‚
â”‚                                                              â”‚
â”‚ 2. Run linter                                               â”‚
â”‚    let mut linter = Linter::new(LintConfig::default());    â”‚
â”‚    linter.lint_str(&new_text, uri)?;                       â”‚
â”‚                                                              â”‚
â”‚ 3. Collect diagnostics                                      â”‚
â”‚    for diag in linter.diagnostics() {                      â”‚
â”‚                                                              â”‚
â”‚ 4. Publish each as notification                             â”‚
â”‚    send_notification({                                      â”‚
â”‚      "method": "textDocument/publishDiagnostics",          â”‚
â”‚      "params": {                                            â”‚
â”‚        "uri": uri,                                          â”‚
â”‚        "diagnostics": [{                                    â”‚
â”‚          "range": {                                         â”‚
â”‚            "start": {"line": 0, "character": 8},           â”‚
â”‚            "end": {"line": 0, "character": 18}             â”‚
â”‚          },                                                 â”‚
â”‚          "severity": 2,  // Warning                        â”‚
â”‚          "code": "W001",                                    â”‚
â”‚          "source": "elle-lint",                            â”‚
â”‚          "message": "should use kebab-case"                â”‚
â”‚        }]                                                   â”‚
â”‚      }                                                      â”‚
â”‚    });                                                      â”‚
â”‚    }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ IDE shows warning squiggly           â”‚
â”‚ "myVariable should use kebab-case"   â”‚
â”‚ with suggestion "my-variable"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Symbol Resolution Pipeline

```
Source Code
   â”‚
   â”œâ”€ "(define my-func (fn [x] (+ x 1)))"
   â”œâ”€ "(my-func 5)"
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Lexer (elle::Lexer)            â”‚
â”‚ â†’ Token stream with SourceLoc  â”‚
â”‚   - Token { value: Symbol("define"), loc: (1, 1) }
â”‚   - Token { value: Symbol("my-func"), loc: (1, 9) }
â”‚   - Token { value: Symbol("fn"), loc: (1, 19) }
â”‚   - ...
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Reader (elle::Reader)          â”‚
â”‚ â†’ Value::Cons structures       â”‚
â”‚   (define my-func (fn ...))    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Compiler (elle::compile)       â”‚
â”‚ â†’ Expr AST with SourceLoc      â”‚
â”‚   Define {                     â”‚
â”‚     name: Symbol("my-func"),   â”‚
â”‚     value: Lambda { ... }      â”‚
â”‚   }                            â”‚
â”‚   Var(Symbol("my-func"), 0, 0) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Server Should Build Index  â”‚
â”‚ (currently doesn't!)           â”‚
â”‚                                â”‚
â”‚ symbol_definitions:            â”‚
â”‚  "my-func" â†’ SourceLoc(1, 9)  â”‚
â”‚                                â”‚
â”‚ symbol_usages:                 â”‚
â”‚  "my-func" â†’ [SourceLoc(2, 1)]â”‚
â”‚                                â”‚
â”‚ scope_frames:                  â”‚
â”‚  SourceLoc(1, 1) â†’ ScopeFrame {â”‚
â”‚    variables: {"x", ...}       â”‚
â”‚  }                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LSP Feature Handlers           â”‚
â”‚                                â”‚
â”‚ hover(pos) â†’ look up symbol    â”‚
â”‚              in index          â”‚
â”‚                                â”‚
â”‚ definition(pos) â†’ return       â”‚
â”‚                  definition    â”‚
â”‚                  location      â”‚
â”‚                                â”‚
â”‚ references(pos) â†’ return all   â”‚
â”‚                   usage locs   â”‚
â”‚                                â”‚
â”‚ completion(pos) â†’ return all   â”‚
â”‚                  symbols in    â”‚
â”‚                  scope         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Structure & Responsibilities

```
elle-lsp/
â”œâ”€â”€ Cargo.toml
â”‚   â””â”€ Dependencies: elle, elle-lint, lsp-types, tokio, serde
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs (166 lines) âœ… WORKING
â”‚   â”‚   â”œâ”€ fn main()
â”‚   â”‚   â”‚  â”œâ”€ stdin/stdout setup
â”‚   â”‚   â”‚  â””â”€ message loop (lines 20-60)
â”‚   â”‚   â”‚     â”œâ”€ read Content-Length header
â”‚   â”‚   â”‚     â”œâ”€ read body
â”‚   â”‚   â”‚     â”œâ”€ parse JSON
â”‚   â”‚   â”‚     â”œâ”€ call handle_request()
â”‚   â”‚   â”‚     â””â”€ write response
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€ fn handle_request() (lines 63-165)
â”‚   â”‚      â”œâ”€ initialize (lines 69-90) âœ…
â”‚   â”‚      â”œâ”€ shutdown (lines 91-97) âœ…
â”‚   â”‚      â”œâ”€ didOpen (lines 98-115) âœ…
â”‚   â”‚      â”œâ”€ didChange (lines 116-135) âœ…
â”‚   â”‚      â”œâ”€ didClose (lines 136-147) âœ…
â”‚   â”‚      â”œâ”€ hover (lines 148-156) âš ï¸ STUB
â”‚   â”‚      â””â”€ default (lines 157-164) âŒ
â”‚   â”‚
â”‚   â”œâ”€â”€ lib.rs (10 lines) âŒ EMPTY
â”‚   â”‚   â””â”€ Should export: pub mod handler, pub mod protocol
â”‚   â”‚
â”‚   â”œâ”€â”€ protocol.rs (2 lines) âŒ EMPTY
â”‚   â”‚   â””â”€ Should contain: Type converters, LSP-specific structs
â”‚   â”‚
â”‚   â””â”€â”€ handler.rs (2 lines) âŒ EMPTY
â”‚       â””â”€ Should contain: Extracted handlers, business logic
â”‚
â””â”€â”€ examples/
    â””â”€â”€ demo.lisp (50 lines)
        â””â”€ Example Elle code demonstrating LSP features
```

---

## Dependency Architecture

```
LSP Server (elle-lsp)
    â”‚
    â”œâ”€â”€â”€ Depends on: elle (main interpreter)
    â”‚    â”œâ”€ Symbol system (symbol.rs)
    â”‚    â”‚  â””â”€ SymbolTable { intern, name, get }
    â”‚    â”‚
    â”‚    â”œâ”€ Reader (reader.rs)
    â”‚    â”‚  â”œâ”€ Lexer { next_token() }
    â”‚    â”‚  â”œâ”€ Reader { try_read() }
    â”‚    â”‚  â””â”€ SourceLoc { line, col }
    â”‚    â”‚
    â”‚    â”œâ”€ Compiler (compiler/)
    â”‚    â”‚  â”œâ”€ ast.rs { Expr enum }
    â”‚    â”‚  â”œâ”€ scope.rs { VariableBinding, ScopeFrame }
    â”‚    â”‚  â””â”€ compile.rs { fn compile(Expr) â†’ Bytecode }
    â”‚    â”‚
    â”‚    â”œâ”€ VM (vm/)
    â”‚    â”‚  â””â”€ execute(bytecode) â†’ Value
    â”‚    â”‚
    â”‚    â””â”€ Value system (value.rs)
    â”‚       â”œâ”€ Value enum
    â”‚       â””â”€ SymbolId(u32)
    â”‚
    â”œâ”€â”€â”€ Depends on: elle-lint (linter)
    â”‚    â”œâ”€ Linter struct
    â”‚    â”‚  â”œâ”€ lint_str(code, filename)
    â”‚    â”‚  â””â”€ diagnostics() â†’ &[Diagnostic]
    â”‚    â”‚
    â”‚    â”œâ”€ Rules
    â”‚    â”‚  â”œâ”€ naming.rs âœ… WORKING
    â”‚    â”‚  â””â”€ arity.rs âŒ STUB
    â”‚    â”‚
    â”‚    â””â”€ Diagnostic struct
    â”‚       â”œâ”€ severity: Severity
    â”‚       â”œâ”€ message: String
    â”‚       â”œâ”€ line: usize
    â”‚       â”œâ”€ column: usize
    â”‚       â””â”€ suggestions: Vec<String>
    â”‚
    â”œâ”€â”€â”€ Depends on: lsp-types 0.95
    â”‚    â””â”€ Standard LSP type definitions
    â”‚
    â”œâ”€â”€â”€ Depends on: serde/serde_json
    â”‚    â””â”€ JSON serialization
    â”‚
    â””â”€â”€â”€ Depends on: tokio 1.35 (optional, not used yet)
         â””â”€ Async runtime (for future websocket support?)
```

---

## What's Missing vs What Works

### âœ… COMPLETE INFRASTRUCTURE

```
Message Loop        Handler Dispatch    Document Tracking
    â†“                    â†“                     â†“
Read JSON-RPC       Route by method     HashMap<URI, Text>
Parse headers       Return JSON         didOpen/Change/Close
Write response      ID correlation      Simple but functional
```

### âŒ MISSING FEATURES

```
Symbol Indexing    Hover Info         Go-to-Definition
    â†“                  â†“                     â†“
Find definitions   Parse to AST       Build symbol map
Track usages       Lookup symbol      Return location
Link references    Get info           Jump to source

Code Completion    Diagnostics        Incremental Sync
    â†“                  â†“                     â†“
Filter symbols     Call linter        Range-based changes
Suggest names      Publish notify      Optimize parsing
Provide arity      Show errors         Better performance
```

---

## Implementation Priority

```
CRITICAL (Block everything)
â”œâ”€ Fix capability declarations
â”œâ”€ Integrate diagnostics
â””â”€ Implement basic hover

HIGH (Must have for MVP)
â”œâ”€ Go-to-definition
â”œâ”€ Find references
â”œâ”€ Code completion
â””â”€ Complete arity rule

MEDIUM (Nice to have)
â”œâ”€ Incremental sync
â”œâ”€ Workspace support
â””â”€ Semantic tokens

LOW (Future)
â”œâ”€ Formatting
â”œâ”€ Rename
â”œâ”€ Call hierarchy
â””â”€ Documentation
```

---

**Status**: Architecture is sound, implementation is incomplete
**Next Step**: Integrate diagnostics (3-4 hours to add real value)
